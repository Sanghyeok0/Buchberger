\chapter{Finset} 

\section{Piecewise}

\begin{lemma}[prod ite not mem]\label{lem:prod_ite_not_mem}
    \lean{Finset.prod_ite_not_mem}
    \leanok
    Let $s, t$ be finite sets of indices in $\iota$, and let $f \colon \iota \to M$. 
    Then
    \[
    \prod_{x \in s} 
    \begin{cases}
    1, & \text{if } x \in t, \\
    f(x), & \text{otherwise}
    \end{cases}
    =
    \prod_{x \in s \setminus t} f(x).
    \]
\end{lemma}
\begin{proof}
    \leanok
    We split the product over the disjoint union $s = (s \setminus t) \cup (s \cap t)$.
    \begin{align*}
    \prod_{x \in s} 
    \begin{cases}
    1, & \text{if } x \in t \\
    f(x), & \text{otherwise}
    \end{cases}
    &=
    \left( \prod_{x \in s \setminus t} f(x) \right)
    \cdot
    \left( \prod_{x \in s \cap t} 1 \right) \\
    &= \prod_{x \in s \setminus t} f(x).
    \end{align*}
    The first equality holds because for any $x \in s \setminus t$, the term is $f(x)$, while for any $x \in s \cap t$, the term is $1$. 
    The product of ones is one.
\end{proof}

\begin{lemma}[sum ite not mem]\label{lem:sum_ite_not_mem}
    \lean{Finset.sum_ite_not_mem}
    \leanok
    Let $s, t$ be finite sets of indices in $\iota$, and let $f \colon \iota \to A$ be a function to an additive commutative monoid. Then
    \[
    \sum_{x \in s} 
    \begin{cases}
    0, & \text{if } x \in t, \\
    f(x), & \text{otherwise}
    \end{cases}
    =
    \sum_{x \in s \setminus t} f(x).
    \]
\end{lemma}
\begin{proof}
    \leanok
    We split the sum over the disjoint union $s = (s \setminus t) \cup (s \cap t)$.
    \begin{align*}
    \sum_{x \in s} 
    \begin{cases}
    0, & \text{if } x \in t \\
    f(x), & \text{otherwise}
    \end{cases}
    &=
    \left( \sum_{x \in s \setminus t} f(x) \right)
    +
    \left( \sum_{x \in s \cap t} 0 \right) \\
    &= \sum_{x \in s \setminus t} f(x).
    \end{align*}
    The first equality holds because for any $x \in s \setminus t$, the term is $f(x)$, while for any $x \in s \cap t$, the term is $0$. 
    The sum of zeros is zero.
\end{proof}

\section{Off-diagonal}

\begin{lemma}[prod product eq prod offDiag of diag one]\label{lem:prod_product_eq_prod_offDiag_of_diag_one}
    \lean{Finset.prod_product_eq_prod_offDiag_of_diag_one}
    \leanok
    Let $s$ be a finite set of indices in $\iota$, and let $F \colon \iota \times \iota \to M$
    where $M$ is a commutative monoid.
    Assume that the diagonal values are all $1$, i.e.
    \[
      \forall a \in s,\quad F(a,a)=1.
    \]
    Then the product of $F$ over the Cartesian product $s\times s$ equals the product over the off-diagonal part:
    \[
      \prod_{x\in s\times s} F(x)
      \;=\;
      \prod_{x\in s.\mathrm{offDiag}} F(x).
    \]
\end{lemma}

\begin{proof}
    \leanok
    We use the decomposition of the square into diagonal and off-diagonal parts:
    \[
      s\times s \;=\; s.\mathrm{diag} \,\cup\, s.\mathrm{offDiag},
    \]
    and these two subsets are disjoint.
    Hence the product over $s\times s$ splits as
    \[
      \prod_{x\in s\times s} F(x)
      \;=\;
      \left(\prod_{x\in s.\mathrm{diag}} F(x)\right)
      \cdot
      \left(\prod_{x\in s.\mathrm{offDiag}} F(x)\right).
    \]
    On the diagonal, we have $F(a,a)=1$ for all $a\in s$, so
    \[
      \prod_{x\in s.\mathrm{diag}} F(x)
      = \prod_{a\in s} F(a,a)
      = \prod_{a\in s} 1
      = 1.
    \]
    Therefore,
    \[
      \prod_{x\in s\times s} F(x)
      = 1 \cdot \prod_{x\in s.\mathrm{offDiag}} F(x)
      = \prod_{x\in s.\mathrm{offDiag}} F(x),
    \]
    which is exactly the desired equality.
\end{proof}

\begin{lemma}[sum product eq sum offDiag of diag zero]\label{lem:sum_product_eq_sum_offDiag_of_diag_zero}
    \lean{Finset.sum_product_eq_sum_offDiag_of_diag_zero}
    \leanok
    Let $s$ be a finite set of indices in $\iota$, and let $F \colon \iota \times \iota \to A$
    where $A$ is an additive commutative monoid.
    Assume that the diagonal values are all $0$, i.e.
    \[
      \forall a \in s,\quad F(a,a)=0.
    \]
    Then the sum of $F$ over the Cartesian product $s\times s$ equals the sum over the off-diagonal part:
    \[
      \sum_{x\in s\times s} F(x)
      \;=\;
      \sum_{x\in s.\mathrm{offDiag}} F(x).
    \]
\end{lemma}

\begin{proof}
    \leanok
    We use the decomposition of the square into diagonal and off-diagonal parts:
    \[
      s\times s \;=\; s.\mathrm{diag} \,\cup\, s.\mathrm{offDiag},
    \]
    and these two subsets are disjoint.
    Hence the sum over $s\times s$ splits as
    \[
      \sum_{x\in s\times s} F(x)
      \;=\;
      \left(\sum_{x\in s.\mathrm{diag}} F(x)\right)
      +
      \left(\sum_{x\in s.\mathrm{offDiag}} F(x)\right).
    \]
    On the diagonal, we have $F(a,a)=0$ for all $a\in s$, so
    \[
      \sum_{x\in s.\mathrm{diag}} F(x)
      = \sum_{a\in s} F(a,a)
      = \sum_{a\in s} 0
      = 0.
    \]
    Therefore,
    \[
      \sum_{x\in s\times s} F(x)
      = 0 + \sum_{x\in s.\mathrm{offDiag}} F(x)
      = \sum_{x\in s.\mathrm{offDiag}} F(x),
    \]
    which is exactly the desired equality.
\end{proof}